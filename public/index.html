<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DotBox Monitor</title>
    <link rel="icon" type="image/svg+xml" href="/img/logo_only.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.11.2/cdn/themes/dark.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.11.2/cdn/shoelace-autoloader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- App CSS -->
    <link rel="stylesheet" href="/css/app.css">
</head>
<body>
    <!-- Top Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <div class="logo">
                <img src="/img/logo.svg" alt="DotBox Monitor" class="logo-image">
            </div>
        </div>
        
        <div class="navbar-center">
            <div class="system-status-mini">
                <div class="status-mini-item">
                    <span class="status-mini-label">Health:</span>
                    <span class="status-mini-value" id="overallHealthText">Loading...</span>
                </div>
                <div class="status-mini-item">
                    <span class="status-mini-label">Services:</span>
                    <span class="status-mini-value" id="servicesCountText">0/0</span>
                </div>
                <div class="status-mini-item">
                    <span class="status-mini-label">Updated:</span>
                    <span class="status-mini-value" id="lastUpdatedText">Never</span>
                    <span class="connection-status" id="connectionStatus" title="WebSocket Connection">üî¥</span>
                </div>
            </div>
        </div>
        
        <div class="navbar-actions">
            <button class="navbar-btn" id="settingsBtn" onclick="showSettingsModal()" title="Settings">
                ‚öôÔ∏è
            </button>
            <button class="navbar-btn" id="addServiceBtn" onclick="showAddServiceModal()" title="Add Service">
                ‚ûï
            </button>

            <button class="navbar-btn" onclick="logout()" title="Logout">
                üö™
            </button>
        </div>
    </nav>

    <!-- Main content -->
    <div class="main-content">
        <div id="servicesContainer" class="services-container"></div>
        
        <!-- Empty state message -->
        <div id="emptyState" class="empty-state hidden">
            <div class="empty-state-icon">üì°</div>
            <h3>No Services Configured</h3>
            <p>Get started by adding your first service to monitor</p>
            <button class="action-btn" onclick="showAddServiceModal()">‚ûï Add Your First Service</button>
        </div>
    </div>

    <!-- Service Detail Sliding Pane -->
    <div class="detail-pane" id="detailPane">
        <div class="detail-pane-header">
            <h3 id="detailPaneTitle">Service Details</h3>
            <div class="detail-pane-actions">
                <button class="detail-pane-btn refresh" id="detailRefreshBtn" onclick="refreshDetailChart(null)" title="Refresh Charts">
                    üîÑ Refresh
                </button>
                <button class="detail-pane-btn edit" id="detailEditBtn" onclick="editServiceFromDetail()" title="Edit Service">
                    ‚úèÔ∏è Edit
                </button>
                <button class="detail-pane-btn delete" id="detailDeleteBtn" onclick="deleteServiceFromDetail()" title="Delete Service">
                    üóëÔ∏è Delete
                </button>
                <button class="detail-pane-close" onclick="closeDetailPane()">‚úï</button>
            </div>
        </div>
        <div class="detail-pane-content" id="detailPaneContent">
            <!-- Service details will be loaded here -->
        </div>
    </div>

    <!-- Detail Pane Overlay -->
    <div class="detail-pane-overlay" id="detailPaneOverlay" onclick="closeDetailPane()"></div>

    <!-- Add Service Modal -->
    <div id="addServiceModal" class="modal hidden">
        <div class="modal-overlay" onclick="hideAddServiceModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Add New Service</h3>
                <button class="modal-close" onclick="hideAddServiceModal()">‚úï</button>
            </div>
            
            <form id="addServiceForm" class="modal-body">
                <div class="form-group">
                    <label for="serviceName">Service Name</label>
                    <input type="text" id="serviceName" name="name" required placeholder="e.g., Home Assistant">
                </div>
                
                <div class="form-group">
                    <label for="serviceType">Service Type</label>
                    <select id="serviceType" name="type" required>
                        <option value="http">HTTP/HTTPS</option>
                        <option value="tcp">TCP Port</option>
                        <option value="ssl">SSL Certificate</option>
                    </select>
                </div>
                
                <!-- HTTP/SSL URL Field -->
                <div class="form-group" id="urlGroup">
                    <label for="serviceUrl">URL</label>
                    <input type="text" id="serviceUrl" name="url" required placeholder="e.g., https://example.com">
                    <small id="urlHelp" style="color: var(--text-secondary); font-size: 12px;">
                        Full URL including protocol (https://example.com)
                    </small>
                </div>
                
                <!-- TCP Host Field -->
                <div class="form-group" id="hostGroup" style="display: none;">
                    <label for="serviceHost">Host</label>
                    <input type="text" id="serviceHost" name="host" placeholder="e.g., atlas.local or 192.168.1.100">
                    <small style="color: var(--text-secondary); font-size: 12px;">
                        Hostname or IP address to connect to
                    </small>
                </div>
                
                <div class="form-group" id="portGroup" style="display: none;">
                    <label for="servicePort">Port</label>
                    <input type="number" id="servicePort" name="port" placeholder="e.g., 22, 80, 443">
                </div>
                
                <div class="form-group">
                    <label for="serviceVisitUrl">Visit URL (optional)</label>
                    <input type="text" id="serviceVisitUrl" name="visit_url" placeholder="e.g., https://example.com/login - URL for the link button">
                    <small style="color: var(--text-secondary); font-size: 12px;">If empty, no link button will be shown. If provided, the link button will use this URL instead.</small>
                </div>
                
                <div class="form-group">
                    <label for="serviceIcon">Icon (emoji)</label>
                    <div class="emoji-input-container">
                        <div class="emoji-search-wrapper">
                            <input type="text" id="emojiSearch" placeholder="Search for emoji..." oninput="handleEmojiSearch(this.value)" onfocus="showEmojiDropdown()" onblur="hideEmojiDropdown()">
                            <div id="emojiDropdown" class="emoji-dropdown hidden">
                                <div class="emoji-option" onclick="selectEmoji('üè†')" data-name="house">üè† house</div>
                                <div class="emoji-option" onclick="selectEmoji('üåê')" data-name="globe">üåê globe</div>
                                <div class="emoji-option" onclick="selectEmoji('üîß')" data-name="wrench">üîß wrench</div>
                                <div class="emoji-option" onclick="selectEmoji('üíª')" data-name="laptop">üíª laptop</div>
                                <div class="emoji-option" onclick="selectEmoji('üì±')" data-name="mobile">üì± mobile</div>
                                <div class="emoji-option" onclick="selectEmoji('‚ö°')" data-name="lightning">‚ö° lightning</div>
                                <div class="emoji-option" onclick="selectEmoji('üîê')" data-name="security">üîê security</div>
                                <div class="emoji-option" onclick="selectEmoji('üîí')" data-name="lock">üîí lock</div>
                                <div class="emoji-option" onclick="selectEmoji('üìä')" data-name="chart">üìä chart</div>
                                <div class="emoji-option" onclick="selectEmoji('üéµ')" data-name="music">üéµ music</div>
                                <div class="emoji-option" onclick="selectEmoji('üì∫')" data-name="tv">üì∫ tv</div>
                            </div>
                        </div>
                        <div class="emoji-preview">
                            <div class="emoji-preview-icon" id="emojiPreview">üîß</div>
                            <input type="hidden" id="serviceIcon" name="icon" value="üîß">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="serviceCategory">Category</label>
                    <select id="serviceCategory" name="category">
                        <option value="web">Web Services</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="home">Home Automation</option>
                        <option value="media">Media</option>
                        <option value="network">Network</option>
                        <option value="security">Security</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Advanced Settings Section -->
                <div style="margin: 2rem 0 1rem 0;">
                    <div style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1rem;">‚öôÔ∏è Advanced Settings</h4>
                        
                        <div class="form-group">
                            <label for="warningThreshold">Warning Threshold</label>
                            <input type="number" id="warningThreshold" name="warning_threshold" min="1">
                            <small id="thresholdHelp" style="color: var(--text-secondary); font-size: 12px;">
                                For HTTP/TCP: Response time in milliseconds (default: 1000ms for HTTP, 500ms for TCP)<br>
                                For SSL: Days before certificate expires (default: 30 days)
                            </small>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="serviceTimeout">Timeout (seconds)</label>
                                <input type="number" id="serviceTimeout" name="timeout" value="5" min="1" max="60">
                            </div>
                            
                            <div class="form-group">
                                <label for="serviceInterval">Check Interval (seconds)</label>
                                <input type="number" id="serviceInterval" name="interval" value="30" min="10" max="3600">
                            </
                            div>
                        </div>
                    </div>
                </div>
            </form>
            
            <div class="modal-footer">
                <button type="button" class="action-btn" onclick="hideAddServiceModal()">Cancel</button>
                <button type="submit" form="addServiceForm" class="action-btn save">Add Service</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="hideSettingsModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è System Settings</h3>
                <button class="modal-close" onclick="hideSettingsModal()">‚úï</button>
            </div>
            
            <form id="settingsForm" class="modal-body">
                <div id="settingsContainer">
                    <!-- Settings will be loaded here -->
                </div>
            </form>
            
            <div class="modal-footer">
                <button type="button" class="action-btn" onclick="hideSettingsModal()">Cancel</button>
                <button type="submit" form="settingsForm" class="action-btn save">Save Settings</button>
            </div>
        </div>
    </div>

    <script src="/app.js"></script>
    <script>
        // Constants
        const STORAGE_KEY = 'dotbox_auth_token';
        const SESSION_CHECK_INTERVAL = 5 * 60 * 1000; // 5 minutes
        let sessionCheckTimer;

        // Check session with server
        async function checkSession() {
            try {
                const response = await fetch('/api/session-check', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                return response.ok;
            } catch (error) {
                console.log('Session check failed:', error);
                return false;
            }
        }

        // Start periodic session checks
        function startSessionChecks() {
            sessionCheckTimer = setInterval(async () => {
                const isValid = await checkSession();
                if (!isValid) {
                    // Session expired, clear storage and redirect
                    localStorage.removeItem(STORAGE_KEY);
                    window.location.href = '/login';
                }
            }, SESSION_CHECK_INTERVAL);
        }

        // Enhanced logout function
        window.logout = function() {
            // Clear persistent auth token
            localStorage.removeItem(STORAGE_KEY);
            
            // Clear session check timer
            if (sessionCheckTimer) {
                clearInterval(sessionCheckTimer);
            }
            
            // Logout from server
            fetch('/logout', { method: 'POST' })
                .then(() => {
                    window.location.href = '/login';
                })
                .catch(() => {
                    // Even if server logout fails, redirect to login
                    window.location.href = '/login';
                });
        };

        // Add Service Modal Functions
        function showAddServiceModal() {
            document.getElementById('addServiceModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function hideAddServiceModal() {
            document.getElementById('addServiceModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset form and UI to "add" mode
            const form = document.getElementById('addServiceForm');
            form.reset();
            form.removeAttribute('data-editing-id');
            
            // Reset emoji preview to default
            document.getElementById('emojiPreview').textContent = 'üîß';
            document.getElementById('serviceIcon').value = 'üîß';
            document.getElementById('emojiSearch').value = '';
            
            // Reset field visibility to HTTP default
            document.getElementById('urlGroup').style.display = 'block';
            document.getElementById('hostGroup').style.display = 'none';
            document.getElementById('portGroup').style.display = 'none';
            document.getElementById('serviceUrl').required = true;
            document.getElementById('serviceHost').required = false;
            document.getElementById('servicePort').required = false;
            
            // Reset warning threshold to HTTP default
            document.getElementById('warningThreshold').value = '1000';
            
            // Reset modal title and button text
            document.querySelector('#addServiceModal .modal-header h3').textContent = '‚ûï Add New Service';
            document.querySelector('button[type="submit"][form="addServiceForm"]').textContent = 'Add Service';
        }

        // Handle service type change
        document.getElementById('serviceType').addEventListener('change', function() {
            const urlGroup = document.getElementById('urlGroup');
            const hostGroup = document.getElementById('hostGroup');
            const portGroup = document.getElementById('portGroup');
            const urlInput = document.getElementById('serviceUrl');
            const hostInput = document.getElementById('serviceHost');
            const portInput = document.getElementById('servicePort');
            const warningThresholdInput = document.getElementById('warningThreshold');
            
            // Reset required attributes
            urlInput.required = false;
            hostInput.required = false;
            portInput.required = false;
            
            // Show/hide fields based on service type
            switch(this.value) {
                case 'http':
                    urlGroup.style.display = 'block';
                    hostGroup.style.display = 'none';
                    portGroup.style.display = 'none';
                    urlInput.required = true;
                    urlInput.placeholder = 'e.g., https://example.com';
                    warningThresholdInput.placeholder = '1000';
                    warningThresholdInput.value = warningThresholdInput.value || '1000';
                    break;
                case 'tcp':
                    urlGroup.style.display = 'none';
                    hostGroup.style.display = 'block';
                    portGroup.style.display = 'block';
                    hostInput.required = true;
                    portInput.required = true;
                    hostInput.placeholder = 'e.g., atlas.local or 192.168.1.100';
                    portInput.placeholder = 'e.g., 22, 80, 443';
                    warningThresholdInput.placeholder = '500';
                    warningThresholdInput.value = warningThresholdInput.value || '500';
                    break;
                case 'ssl':
                    urlGroup.style.display = 'block';
                    hostGroup.style.display = 'none';
                    portGroup.style.display = 'none';
                    urlInput.required = true;
                    urlInput.placeholder = 'e.g., https://example.com';
                    warningThresholdInput.placeholder = '30';
                    warningThresholdInput.value = warningThresholdInput.value || '30';
                    break;
            }
        });

        // Handle add/edit service form submission
        document.getElementById('addServiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const isEditing = form.hasAttribute('data-editing-id');
            const editingId = form.getAttribute('data-editing-id');
            
            const submitBtn = document.querySelector('button[type="submit"][form="addServiceForm"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = isEditing ? 'Updating...' : 'Adding...';
            submitBtn.disabled = true;
            
            const formData = new FormData(form);
            const serviceData = Object.fromEntries(formData.entries());
            
            // For TCP services, use host field instead of url
            if (serviceData.type === 'tcp') {
                // Remove url field if it exists, use host field
                delete serviceData.url;
                // Host is already in serviceData.host from the form
            } else {
                // For HTTP/SSL, remove host field if it exists
                delete serviceData.host;
                // URL is already in serviceData.url from the form
            }
            
            // Convert numeric fields
            serviceData.timeout = parseInt(serviceData.timeout);
            serviceData.interval = parseInt(serviceData.interval);
            if (serviceData.port) {
                serviceData.port = parseInt(serviceData.port);
            }
            if (serviceData.warning_threshold) {
                serviceData.warning_threshold = parseInt(serviceData.warning_threshold);
            }
            
            // Set expected status based on type
            serviceData.expected_status = serviceData.type === 'http' ? 200 : null;
            
            try {
                const url = isEditing ? `/api/services/${editingId}` : '/api/services';
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(serviceData),
                });
                
                if (response.ok) {
                    const result = await response.json();
                    hideAddServiceModal();
                    
                    // Show success notification
                    if (window.monitor) {
                        const message = isEditing 
                            ? `Service "${serviceData.name}" updated successfully!`
                            : `Service "${serviceData.name}" added successfully! (ID: ${result.id})`;
                        window.monitor.showNotification(message, 'success');
                        // Refresh services without full page reload
                        window.monitor.refreshHealth();
                    }
                } else {
                    const error = await response.json();
                    const action = isEditing ? 'update' : 'add';
                    if (window.monitor) {
                        window.monitor.showNotification(`Failed to ${action} service: ${error.error || error.message}`, 'danger');
                    } else {
                        alert(`Error ${action}ing service: ${error.error || error.message}`);
                    }
                }
            } catch (error) {
                const action = isEditing ? 'update' : 'add';
                if (window.monitor) {
                    window.monitor.showNotification(`Error ${action}ing service: ${error.message}`, 'danger');
                } else {
                    alert(`Error ${action}ing service: ${error.message}`);
                }
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Add event listener for add service button
        document.getElementById('addServiceBtn').addEventListener('click', showAddServiceModal);

        // Settings Modal Functions
        async function showSettingsModal() {
            const modal = document.getElementById('settingsModal');
            const modalContent = modal.querySelector('.modal-content');
            const modalOverlay = modal.querySelector('.modal-overlay');
            const container = document.getElementById('settingsContainer');
            
            console.log('Opening settings modal...');
            
            // Check both modals before doing anything
            const addModal = document.getElementById('addServiceModal');
            console.log('üîç BEFORE - Add Service Modal:', {
                display: window.getComputedStyle(addModal).display,
                classes: addModal.className
            });
            console.log('üîç BEFORE - Settings Modal:', {
                display: window.getComputedStyle(modal).display,
                style: modal.style.display
            });
            
            // FORCE close add service modal first
            addModal.classList.add('hidden');
            
            // Show modal with direct display control (not using .hidden class)
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.zIndex = '99999'; // Super high z-index to be above navbar
            
            // Force modal content to be visible
            modalContent.style.display = 'block';
            modalContent.style.visibility = 'visible';
            modalContent.style.opacity = '1';
            modalContent.style.transform = 'scale(1) translateY(0)';
            modalContent.style.position = 'relative';
            modalContent.style.zIndex = '100000'; // Even higher
            
            // Force overlay to be visible
            modalOverlay.style.display = 'block';
            modalOverlay.style.visibility = 'visible';
            modalOverlay.style.opacity = '1';
            modalOverlay.style.position = 'absolute';
            modalOverlay.style.zIndex = '99998';
            
            document.body.style.overflow = 'hidden';
            
            // Check both modals after changes
            console.log('üîç AFTER - Add Service Modal:', {
                display: window.getComputedStyle(addModal).display,
                classes: addModal.className
            });
            console.log('üîç AFTER - Settings Modal:', {
                display: window.getComputedStyle(modal).display,
                style: modal.style.display
            });
            
            console.log('‚úÖ Settings modal opened successfully');
            
            // Load settings from API
            try {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-primary);">Loading settings...</div>';
                
                const response = await fetch('/api/settings');
                if (response.ok) {
                    const settings = await response.json();
                    console.log('Settings loaded:', settings);
                    if (settings && settings.length > 0) {
                        renderSettingsForm(settings);
                    } else {
                        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No settings configured yet. Settings will appear here once the system initializes.</div>';
                    }
                } else {
                    console.error('Failed to load settings, status:', response.status);
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--accent-red);">Failed to load settings. Please try again.</div>';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--accent-red);">Error loading settings: ' + error.message + '</div>';
            }
        }

        function hideSettingsModal() {
            console.log('Hiding settings modal...');
            const modal = document.getElementById('settingsModal');
            
            // Hide modal with direct display control
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function renderSettingsForm(settings) {
            const container = document.getElementById('settingsContainer');
            
            const settingsHtml = settings.map(setting => {
                const inputType = setting.key.includes('days') || setting.key.includes('hours') || 
                                setting.key.includes('interval') || setting.key.includes('entries') ? 'number' : 'text';
                
                let min = '';
                if (inputType === 'number') {
                    if (setting.key.includes('interval') && setting.key.includes('min')) {
                        min = 'min="1"';
                    } else if (setting.key.includes('hours') || setting.key.includes('days')) {
                        min = 'min="1"';
                    } else if (setting.key.includes('entries')) {
                        min = 'min="100"';
                    }
                }
                
                return `
                    <div class="form-group">
                        <label for="setting_${setting.key}">${formatSettingLabel(setting.key)}</label>
                        <input type="${inputType}" 
                               id="setting_${setting.key}" 
                               name="${setting.key}" 
                               value="${setting.value || ''}" 
                               ${min}
                               required>
                        <small style="color: var(--text-secondary); font-size: 12px;">
                            ${setting.description || ''}
                        </small>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = settingsHtml;
        }

        function formatSettingLabel(key) {
            return key.split('_')
                     .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                     .join(' ');
        }

        // Handle settings form submission
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.querySelector('button[type="submit"][form="settingsForm"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;
            
            const formData = new FormData(e.target);
            const settings = Object.fromEntries(formData.entries());
            
            try {
                const updatePromises = Object.entries(settings).map(([key, value]) => {
                    return fetch(`/api/settings/${key}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ value: value }),
                    });
                });
                
                const responses = await Promise.all(updatePromises);
                const allSuccessful = responses.every(response => response.ok);
                
                if (allSuccessful) {
                    hideSettingsModal();
                    if (window.monitor) {
                        window.monitor.showNotification('Settings saved successfully!', 'success');
                        // Reload min check interval for service form
                        if (typeof loadMinCheckInterval === 'function') {
                            loadMinCheckInterval();
                        }
                    }
                } else {
                    if (window.monitor) {
                        window.monitor.showNotification('Failed to save some settings', 'danger');
                    } else {
                        alert('Failed to save some settings');
                    }
                }
            } catch (error) {
                if (window.monitor) {
                    window.monitor.showNotification('Error saving settings: ' + error.message, 'danger');
                } else {
                    alert('Error saving settings: ' + error.message);
                }
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Emoji autocomplete functionality
        let emojiApiKey = 'd5d786602c5d9b1497bbd87a2a8e2beeacea2d1e';
        let allEmojis = null;
        let emojiDropdownTimeout = null;

        // Load emojis from API on page load
        async function loadEmojisFromAPI() {
            try {
                const response = await fetch(`https://emoji-api.com/emojis?access_key=${emojiApiKey}`);
                if (response.ok) {
                    allEmojis = await response.json();
                    console.log('Loaded', allEmojis.length, 'emojis from API');
                }
            } catch (error) {
                console.log('Could not load emojis from API, using fallback');
            }
        }

        function selectEmoji(emoji) {
            document.getElementById('serviceIcon').value = emoji;
            document.getElementById('emojiPreview').textContent = emoji;
            document.getElementById('emojiDropdown').classList.add('hidden');
            document.getElementById('emojiSearch').value = ''; // Clear search
        }

        function showEmojiDropdown() {
            clearTimeout(emojiDropdownTimeout);
            const dropdown = document.getElementById('emojiDropdown');
            dropdown.classList.remove('hidden');
            
            // Load API emojis if not loaded yet
            if (!allEmojis && emojiApiKey) {
                loadEmojisFromAPI();
            }
        }

        function hideEmojiDropdown() {
            emojiDropdownTimeout = setTimeout(() => {
                document.getElementById('emojiDropdown').classList.add('hidden');
            }, 150); // Delay to allow clicking on options
        }

        function handleEmojiSearch(query) {
            const dropdown = document.getElementById('emojiDropdown');
            
            if (!query.trim()) {
                // Show default emojis
                showDefaultEmojis();
                return;
            }

            let results = [];
            
            if (allEmojis) {
                // Search in API data
                results = allEmojis.filter(emoji => 
                    emoji.unicodeName.toLowerCase().includes(query.toLowerCase()) ||
                    emoji.slug.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 10); // Top 10 results
            } else {
                // Fallback search
                const fallbackEmojis = [
                    {character: 'üè†', name: 'house'},
                    {character: 'üåê', name: 'globe'},
                    {character: 'üîß', name: 'wrench'},
                    {character: 'üíª', name: 'laptop'},
                    {character: 'üì±', name: 'mobile'},
                    {character: '‚ö°', name: 'lightning'},
                    {character: 'üîê', name: 'security'},
                    {character: 'üîí', name: 'lock'},
                    {character: 'üìä', name: 'chart'},
                    {character: 'üéµ', name: 'music'},
                    {character: 'üì∫', name: 'tv'},
                    {character: 'üñ•Ô∏è', name: 'computer'},
                    {character: 'üîë', name: 'key'},
                    {character: 'üìÅ', name: 'folder'},
                    {character: 'üíæ', name: 'disk'},
                    {character: 'üåç', name: 'earth'},
                    {character: '‚òÅÔ∏è', name: 'cloud'},
                    {character: 'üöÄ', name: 'rocket'},
                    {character: '‚öôÔ∏è', name: 'gear'},
                    {character: 'üõ†Ô∏è', name: 'tools'}
                ];
                
                results = fallbackEmojis.filter(emoji => 
                    emoji.name.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 10);
            }

            // Update dropdown content
            if (results.length > 0) {
                dropdown.innerHTML = results.map(emoji => {
                    const char = emoji.character || emoji.character;
                    const name = emoji.unicodeName || emoji.name;
                    return `<div class="emoji-option" onclick="selectEmoji('${char}')" data-name="${name}">${char} ${name}</div>`;
                }).join('');
            } else {
                dropdown.innerHTML = '<div class="emoji-no-results">No emojis found</div>';
            }
        }

        function showDefaultEmojis() {
            const dropdown = document.getElementById('emojiDropdown');
            const defaultEmojis = [
                {char: 'üè†', name: 'house'},
                {char: 'üåê', name: 'globe'},
                {char: 'üîß', name: 'wrench'},
                {char: 'üíª', name: 'laptop'},
                {char: 'üì±', name: 'mobile'},
                {char: '‚ö°', name: 'lightning'},
                {char: 'üîê', name: 'security'},
                {char: 'üîí', name: 'lock'},
                {char: 'üìä', name: 'chart'},
                {char: 'üéµ', name: 'music'},
                {char: 'üì∫', name: 'tv'}
            ];
            
            dropdown.innerHTML = defaultEmojis.map(emoji => 
                `<div class="emoji-option" onclick="selectEmoji('${emoji.char}')" data-name="${emoji.name}">${emoji.char} ${emoji.name}</div>`
            ).join('');
        }

        // Legacy functions - no longer used with sliding pane
        // function toggleServiceDetails(serviceId) { /* moved to sliding pane */ }
        // function refreshServiceChart(serviceId) { /* moved to detail pane */ }

        // Load emojis when page loads
        document.addEventListener('DOMContentLoaded', () => {
            if (emojiApiKey) {
                loadEmojisFromAPI();
            }
        });

        // Initialize session checks on page load
        document.addEventListener('DOMContentLoaded', () => {
            startSessionChecks();
            
            // Initialize warning threshold default for HTTP
            const warningThresholdInput = document.getElementById('warningThreshold');
            if (warningThresholdInput && !warningThresholdInput.value) {
                warningThresholdInput.value = '1000';
                warningThresholdInput.placeholder = '1000';
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (sessionCheckTimer) {
                clearInterval(sessionCheckTimer);
            }
        });
    </script>
</body>
</html> 